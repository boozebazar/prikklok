<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prikklok</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&display=swap" rel="stylesheet">
<!-- Kalmer, iOS-achtige UI -->
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --line:#e7e9ee;
    --primary:#a78bfa;
    --primary-strong:#7c61f2;
    --success:#0ea5a4;
    --danger:#ef4444;
    --shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.08);
    --radius-xl:22px;
    --radius-lg:18px;
    --radius-md:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Layout */
  .wrap{max-width:920px;margin:auto;padding:20px}
  .stack{display:grid;gap:20px}
  .cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius-xl);
    padding:18px;
    box-shadow:var(--shadow);
  }
  .soft-sep{height:1px;background:var(--line);margin:16px 0}

/* TITEL */
h1{
  font-family:"Merriweather", Georgia, "Times New Roman", serif;
  font-weight:900;
  font-size:56px;          /* groter */
  line-height:1.05;
  letter-spacing:.01em;
  text-align:center;
}

  /* Inputs & buttons */
  label{display:block;font-size:12px;color:var(--muted);margin:.35rem 0 .25rem}
  input,button,textarea{
    width:100%;padding:12px 14px;border-radius:var(--radius-md);
    border:1px solid var(--line);background:#fbfbfd;color:var(--ink);
    transition:box-shadow .15s, border-color .15s, background .15s;
  }
  input:focus,textarea:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px rgba(167,139,250,.2)}
  button{cursor:pointer}
  button.primary{
    background:linear-gradient(180deg, var(--primary) 0%, var(--primary-strong) 100%);
    color:white; border:0; font-weight:700;
  }
  button.primary:active{transform:translateY(1px)}
  button.ghost{background:#fff;border:1px solid var(--line)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row>div{flex:1}

  /* Tabel */
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{font-weight:600;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
  tbody tr{background:var(--card)}
  th,td{padding:10px 12px;text-align:left;border-top:1px solid var(--line)}
  tbody tr:first-child td{border-top:1px solid var(--line)}
  tbody tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
  tbody tr:last-child td{border-bottom:1px solid var(--line)}
  .pill{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f8f9fe;font-size:12px;color:var(--ink)}
  .right{float:right}

  /* Pauzerijen */
  .pauseRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
  .pauseRow .endcol{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end}
  .pauseRow .rm{width:auto;padding:9px 12px}
  /* Notitie over volle breedte */
  .pauseRow .note-wrap{grid-column:1/-1}
  .pauseRow .note-wrap input{width:100%}

  /* KPI → vervangen door radial */
  .radial-wrap{display:grid;grid-template-columns:1fr auto;align-items:center;gap:16px}
  .radial{
    position:relative;width:180px;height:180px;margin:auto;
    display:grid;place-items:center;
  }
  .radial svg{width:100%;height:100%;transform:rotate(-90deg)}
  
.radial{ position:relative; }
.radial .center{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  pointer-events:none;
}
.radial .big{
  position:relative;           /* niet meer absoluut nodig */
  transform:none;              /* geen translate meer */
  font-family:"Merriweather", Georgia, "Times New Roman", serif;
  font-weight:900; font-size:28px; letter-spacing:.02em; color:var(--ink);
}
.radial .subcap{
  margin-top:4px; font-size:14px; font-weight:600; color:var(--muted);
}
  
/* (optioneel) kleine tekstregels in het midden */
.center small{ display:block; color:var(--muted); font-weight:600; }

/* delta-styling elders */
.delta{ margin-top:8px; font-weight:700; }

  /* Weekgrafiek */
  .barwrap{
    position:relative;height:300px;padding:16px 16px 42px;border:1px solid var(--line);
    border-radius:var(--radius-lg);background:#fbfbfe;box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
  }
  .bars{position:absolute;inset:18px 18px 42px 18px;display:grid;grid-template-columns:repeat(7,1fr);gap:12px;align-items:end}
  .bar{background:linear-gradient(180deg, rgba(167,139,250,.9), rgba(124,97,242,.9));border:0;border-radius:12px;position:relative;box-shadow:0 6px 16px rgba(124,97,242,.18)}
  .bar .val{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--muted)}
  .xlabels{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin-top:12px}
  .xlabels div{text-align:center;font-size:12px;color:var(--muted)}
  .yticks{position:absolute;inset:18px 18px 42px 18px}
  .yticks .tick{position:absolute;left:0;right:0;border-top:1px dashed #dfe3ef}
  .target{position:absolute;left:18px;right:18px;border-top:2px solid var(--primary-strong);opacity:.35}
  .legend{display:flex;gap:12px;font-size:12px;color:var(--muted);margin-top:10px;align-items:center}
  .legend .sw{width:10px;height:10px;border-radius:2px;background:var(--primary-strong);box-shadow:0 0 0 2px rgba(124,97,242,.15) inset}
  .legend .sw.target{background:transparent;border:2px solid var(--primary-strong)}

  /* Weeknavigatie – iOS segment, over de breedte */
  .seg{
    display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:4px 0 10px;
  }
  .seg button{
    background:#fff;border:1px solid var(--line);border-radius:999px;padding:10px 14px;
    box-shadow:var(--shadow);font-weight:700;
  }

  /* Archief – meer spacing + afgeronde items */
  details.collapsible{border:1px solid var(--line);border-radius:var(--radius-xl);background:var(--card);box-shadow:var(--shadow)}
  details.collapsible>summary{list-style:none;cursor:pointer;font-weight:700;display:flex;align-items:center;gap:8px;padding:12px 14px}
  details.collapsible .content{padding:12px 14px}
  .monthGroup{margin-bottom:14px}
  .arch-row{
    background:#fbfbfe;border:1px solid var(--line);border-radius:var(--radius-lg);
    padding:10px 12px;margin-bottom:10px;
  }
  .arch-head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:4px}
  .arch-date{font-weight:700}
  .arch-total{font-weight:700;color:var(--ink)}
  .arch-actions button{padding:6px 10px}

  /* Mobile */
  @media (max-width:520px){
    .wrap{padding:16px}
    h1{font-size:28px}
    .barwrap{height:260px}
    .radial{width:160px;height:160px}
  }
</style>
</head>
<body>
  <div class="wrap stack">
    <div class="card">
      <h1>Prikklok</h1>
      <div class="sub" id="todayLabel"></div>

      <div class="soft-sep"></div>

      <div class="card">
        <h2>Uren registreren</h2>
        <div class="row">
          <div><label>Datum</label><input type="date" id="date"></div>
          <div><label>Start</label><input type="time" id="start"></div>
          <div><label>Einde</label><input type="time" id="end"></div>
        </div>
        <div class="row">
          <div><label>Pauzes (extra min)</label><input type="number" id="pauseExtra" min="0" step="1" placeholder="bv. 15"></div>
          <div><label>Of: totaal gewerkt (min)</label><input type="number" id="totalOverride" min="0" step="1" placeholder="bv. 450"></div>
          <div><label>Dagnotitie</label><input id="dayNote" placeholder="optioneel"></div>
        </div>

        <label style="margin-top:.6rem">Pauzes met notitie</label>
        <div id="pauseList"></div>
        <div class="row"><div style="flex-basis:100%"><button class="ghost" id="addPause">+ pauze</button></div></div>

        <div class="row" style="margin-top:8px">
          <button class="primary" id="saveEntry">Opslaan</button>
          <button class="ghost" id="nowStart">Nu starten</button>
          <button class="ghost" id="nowEnd">Nu stoppen</button>
          <button class="ghost" id="clearForm">Leeg formulier</button>
        </div>
        <small class="muted">Opslag: lokaal. Sync: automatisch met GitHub Gist (zie onderaan).</small>
      </div>

      <div class="soft-sep"></div>

      <div class="cols">
        <div class="card">
          <h2>Vandaag</h2>
          <table>
            <thead><tr><th>Interval</th><th>Pauze</th><th>Totaal</th><th></th></tr></thead>
            <tbody id="todayBody"></tbody>
          </table>
          <div class="right muted" id="todayTotal"></div>
        </div>

        <div class="card">
          <h2>Maandteller</h2>
          <div class="radial-wrap">
<div class="radial" id="monthDonut">
  <svg viewBox="0 0 120 120">
                <!-- achtergrond -->
                <circle cx="60" cy="60" r="52" fill="none" stroke="#eef1f7" stroke-width="12" />
                <!-- progress -->
                <circle id="monthArc" cx="60" cy="60" r="52" fill="none"
                        stroke="url(#grad1)" stroke-linecap="round" stroke-width="12"
                        stroke-dasharray="0 999" stroke-dashoffset="0" />
                <defs>
                  <linearGradient id="grad1" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="var(--primary)"/>
                    <stop offset="100%" stop-color="var(--primary-strong)"/>
                  </linearGradient>
                </defs>
              </svg>
  <div class="center">
    <div class="big" id="monthWorkedHBig"></div>
    <small class="subcap" id="monthExpectedHInside"></small>
  </div>
</div>
            </div>
            <div>
              <div class="muted" id="monthWd"></div>
              <div class="delta" id="monthDeltaH"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Overzicht van deze week</h2>

        <div class="seg">
          <button class="ghost" id="prevWeek">◀</button>
          <button class="ghost" id="thisWeek">Vandaag</button>
          <button class="ghost" id="nextWeek">▶</button>
        </div>
        <div class="muted" id="weekRange" style="margin-bottom:8px"></div>

        <div class="barwrap" id="weekChart">
          <div class="yticks" id="yticks"></div>
          <div class="target" id="targetLine"></div>
          <div class="bars" id="bars"></div>
        </div>
        <div class="xlabels" id="xlabels"></div>
        <div class="right muted" id="weekTotal" style="margin-top:6px;font-weight:600"></div>
        <div class="legend"><span class="sw"></span>Uren per dag <span class="sw target"></span>Doel 7u36</div>
      </div>

      <div class="card">
        <details class="collapsible" id="archiveCollapse">
          <summary>Archief per dag (per maand gegroepeerd)</summary>
          <div class="content" id="archiveContainer"></div>
        </details>
      </div>

      <div class="cols">
        <div class="card">
          <h2>Export</h2>
          <div class="row">
            <button class="primary" id="exportWeekCsv">CSV huidige week</button>
            <button class="primary" id="exportMonthCsv">CSV huidige maand</button>
            <button class="ghost" id="exportJson">Export JSON</button>
            <label style="flex-basis:100%">Import JSON<input type="file" id="importJson" accept="application/json"></label>
          </div>
          <small class="muted">CSV: datum, start, stop, totaal min, te presteren, pauze min, notities pauze.</small>
        </div>

        <div class="card">
          <h2>GitHub Gist auto-sync</h2>
          <label>Gist ID<input id="ghGist" placeholder="bv. 2591...fcc6"></label>
          <label>GitHub Token<input id="ghToken" placeholder="ghp_..."></label>
          <label>Bestandsnaam<input id="ghFile" value="prikklok.json"></label>
          <div class="row"><button class="ghost" id="saveCreds">Bewaar op dit toestel</button></div>
          <small class="muted">Token en Gist ID worden lokaal bewaard in <code>localStorage</code>. Auto-sync: pull bij laden, push na elke wijziging.</small>
        </div>
      </div>
    </div>
  </div>

<script>
/* --- Config --- */
const AVG_DAY_HOURS = 7.6; // 7u36
const STORAGE_KEY   = 'prikklokEntriesV2';
const GIST_FILE_KEY = 'prikklokGistFile';
const GIST_ID_KEY   = 'prikklokGistId';
const TOKEN_KEY     = 'prikklokToken';
const DEFAULT_GIST_FILENAME = 'prikklok.json';

/* --- Utils --- */
const pad = n => String(n).padStart(2,'0');
const toHM = mins => { const h=Math.floor(mins/60), m=mins%60; return `${h}u${pad(m)}`; };
const parseTime = t => { const [H,M]=t.split(':').map(Number); return H*60+M; };
const diffHM = (a,b) => { const sa=parseTime(a), sb=parseTime(b); const gross = sb>=sa ? (sb-sa) : (sb+1440-sa); return Math.max(0,gross); };
const ymdLocal = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const fmtDate = d => new Date(d+'T00:00:00');
const todayISO = () => ymdLocal(new Date());
const toEU = iso => { const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
const isWeekend = dt => { const v=dt.getDay(); return v===0||v===6; };
const mondayOfWeek = (dt) => { const d=new Date(dt); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d; };
const addDays = (dt,n)=>{ const d=new Date(dt); d.setDate(d.getDate()+n); return d; };
const cap = s => s.charAt(0).toUpperCase()+s.slice(1);
const download = (filename, text, type='text/plain') => {
  const blob = new Blob([text],{type}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
};

/* --- Storage --- */
const load = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch(e){ return []; } };
function save(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); scheduleSyncPush(); }

/* --- Gist sync (auto) --- */
const getGistId  = () => (document.getElementById('ghGist')?.value?.trim() || localStorage.getItem(GIST_ID_KEY) || '');
const getToken   = () => (document.getElementById('ghToken')?.value?.trim() || localStorage.getItem(TOKEN_KEY)   || '');
const getGistFile= () => (document.getElementById('ghFile') ?.value?.trim() || localStorage.getItem(GIST_FILE_KEY)|| DEFAULT_GIST_FILENAME);

async function gistGet(gistId, token){
  const r = await fetch('https://api.github.com/gists/'+gistId, {
    headers: { 'Accept':'application/vnd.github+json', ...(token?{'Authorization':'token '+token}:{}) }
  });
  if(!r.ok) throw new Error('GitHub '+r.status+' '+await r.text());
  return r.json();
}
async function gistPatch(gistId, token, filename, content){
  const r = await fetch('https://api.github.com/gists/'+gistId, {
    method:'PATCH',
    headers:{ 'Accept':'application/vnd.github+json', 'Content-Type':'application/json', 'Authorization':'token '+token },
    body: JSON.stringify({ files: { [filename]: { content } } })
  });
  if(!r.ok) throw new Error('GitHub '+r.status+' '+await r.text());
  return r.json();
}

let syncTimer=null;
function scheduleSyncPush(){ clearTimeout(syncTimer); syncTimer=setTimeout(syncPush, 500); }

async function syncPull(){
  const id=getGistId(); if(!id) return;
  const t = getToken();
  const f = getGistFile();
  try{
    const j = await gistGet(id, t);
    const file = j.files?.[f];
    if(!file) return;
    const data = file.content ? JSON.parse(file.content) : await (await fetch(file.raw_url)).json();
    if(Array.isArray(data)){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); render(); }
  }catch(e){ console.warn('Auto-pull fout:', e.message); }
}
async function syncPush(){
  const id=getGistId(), t=getToken(), f=getGistFile();
  if(!id || !t) return;
  try{
    const content = JSON.stringify(load(), null, 2);
    await gistPatch(id, t, f, content);
  }catch(e){ console.warn('Auto-push fout:', e.message); }
}

/* --- Pauses --- */
const sumPauses = pauses => (!pauses||!pauses.length)?0:pauses.reduce((s,p)=> s + (p.from&&p.to ? diffHM(p.from,p.to) : 0), 0);
const totalPauseMinutes = e => (sumPauses(e.pauses)||0) + (Number(e.pauseMin)||0);

function makePauseRow(containerId, from='', to='', note=''){
  const c = document.getElementById(containerId);
  const row = document.createElement('div'); row.className='pauseRow';
  row.innerHTML = `
    <div><label>Van</label><input type="time" class="pFrom" value="${from}"></div>
    <div class="endcol">
      <div><label>Tot</label><input type="time" class="pTo" value="${to}"></div>
      <button class="ghost rm" type="button" title="Verwijder">✕</button>
      <div class="note-wrap">
        <label>Notitie bij pauze</label>
        <input class="pNote" placeholder="bv. boodschap, verplaatsing" value="${note?.replace?.(/"/g,'&quot;')||''}">
      </div>
    </div>`;
  row.querySelector('.rm').onclick = ()=> row.remove();
  c.appendChild(row);
}
const collectPauses = containerId =>
  Array.from(document.querySelectorAll(`#${containerId} .pauseRow`)).map(r=>{
    const from=r.querySelector('.pFrom').value;
    const to=r.querySelector('.pTo').value;
    const note=r.querySelector('.pNote').value.trim();
    return (from&&to) ? {from,to,note:note||undefined} : null;
  }).filter(Boolean);

/* --- Helpers --- */
const upsert = entry => { const all=load(); const i=all.findIndex(x=>x.id===entry.id); if(i>=0) all[i]=entry; else all.push(entry); save(all); render(); };
const removeEntry = id => { save(load().filter(x=>x.id!==id)); render(); };
const entriesByDate = () => load().reduce((acc,e)=>{ (acc[e.date]=acc[e.date]||[]).push(e); return acc; },{});
const totalPerDate = date => (entriesByDate()[date]||[]).reduce((s,e)=> s+(e.totalMin||0), 0);
const monthSpan = dt => { const y=dt.getFullYear(), m=dt.getMonth(); return {start:new Date(y,m,1), end:new Date(y,m+1,0)}; };
const workingDaysInMonth = dt => { const {start,end}=monthSpan(dt); let c=0, d=new Date(start); while(d<=end){ if(!isWeekend(d)) c++; d.setDate(d.getDate()+1);} return c; };
const totalsThisMonth = () => { const now=new Date(); const {start,end}=monthSpan(now); const map=entriesByDate(); let mins=0; for(const date in map){ const d=fmtDate(date); if(d>=start && d<=end) mins += totalPerDate(date); } return mins; };

/* --- UI render --- */
function render(){
  const now=new Date();
  const fmt=now.toLocaleString('nl-BE',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  document.getElementById('todayLabel').textContent = cap(fmt);

  const tISO = todayISO();
  const tBody = document.getElementById('todayBody'); tBody.innerHTML='';
  (entriesByDate()[tISO]||[]).sort((a,b)=> (a.start||'')<(b.start||'')?-1:1).forEach(e=>{
    const tr=document.createElement('tr');
    const pmin = totalPauseMinutes(e);
    const interval = e.start && e.end ? `${e.start} – ${e.end}` : (e.totalMin? 'Handmatig totaal' : '—');
    tr.innerHTML = `<td>${interval} ${e.note?`<span class="pill">${e.note}</span>`:''}</td>
                    <td>${toHM(pmin)}</td>
                    <td>${toHM(e.totalMin||0)}</td>
                    <td><button class="ghost" type="button" onclick="removeEntry('${e.id}')">Verwijder</button></td>`;
    tBody.appendChild(tr);
  });
  document.getElementById('todayTotal').textContent = `Totaal vandaag: ${toHM(totalPerDate(tISO))}`;

  drawWeek();

  // Maandteller → radial
  const mWorkedMin = totalsThisMonth();
  const wd = workingDaysInMonth(new Date());
  const expectedMin = Math.round(wd * AVG_DAY_HOURS * 60);
  const delta = mWorkedMin - expectedMin;

document.getElementById('monthWorkedHBig').textContent = toHM(mWorkedMin);
document.getElementById('monthExpectedHInside').textContent = 'van ' + toHM(expectedMin);
  document.getElementById('monthWd').textContent = `${wd} werkdagen × 7u36`;

  const arc = document.getElementById('monthArc');
  const R = 52, C = 2*Math.PI*R;
  const ratio = expectedMin>0 ? Math.min(mWorkedMin/expectedMin, 1.2) : 0; // cap at 120%
  arc.setAttribute('stroke-dasharray', C + ' ' + C);
  arc.setAttribute('stroke-dashoffset', C * (1 - Math.min(ratio,1)));

  const deltaEl = document.getElementById('monthDeltaH');
  deltaEl.textContent = (delta>=0?'+':'') + toHM(Math.abs(delta));
  deltaEl.style.color = delta>=0 ? 'var(--success)' : 'var(--danger)';

  renderArchive();
}

/* Archief – cards per dag */
function renderArchive(){
  const container=document.getElementById('archiveContainer'); container.innerHTML='';
  const map=entriesByDate(); const dates=Object.keys(map).sort();
  if(!dates.length){ container.innerHTML='<div class="muted">Geen data</div>'; return; }
  const groups={}; dates.forEach(d=>{const [y,m]=d.split('-'); (groups[`${y}-${m}`]=groups[`${y}-${m}`]||[]).push(d);});
  const keys=Object.keys(groups).sort().reverse();
  keys.forEach(key=>{
    const monthDates=[...new Set(groups[key])].sort();
    let monthMin=0; monthDates.forEach(d=> monthMin+=totalPerDate(d));
    const monthDate=new Date(key+'-01T00:00:00');
    const label=cap(monthDate.toLocaleDateString('nl-BE',{month:'long',year:'numeric'}));

    const dEl=document.createElement('details'); dEl.className='monthGroup';
    const sEl=document.createElement('summary');
    sEl.innerHTML=`<span>${label}</span><span class="right muted">Totaal ${toHM(monthMin)}</span>`;
    dEl.appendChild(sEl);

    const wrap=document.createElement('div');

    monthDates.forEach(d=>{
      const det = map[d].map(e=>{
        const parts=[];
        if(e.start&&e.end) parts.push(`${e.start}–${e.end}`);
        const pmin = totalPauseMinutes(e); parts.push(`pauze ${toHM(pmin)}`);
        const pNotes = (e.pauses||[]).map(p=>p.note).filter(Boolean).join('; ');
        if(pNotes) parts.push(`“${pNotes}”`);
        if(e.note) parts.push(`dag: “${e.note}”`);
        return parts.join(' · ');
      }).join(' | ');

      const row=document.createElement('div'); row.className='arch-row';
      row.innerHTML=`
        <div class="arch-head">
          <div class="arch-date">${toEU(d)}</div>
          <div class="arch-total">${toHM(totalPerDate(d))}</div>
          <div class="arch-actions"><button class="ghost" type="button" onclick="deleteDay('${d}')">Wis dag</button></div>
        </div>
        <div class="muted">${det||'—'}</div>`;
      wrap.appendChild(row);
    });

    dEl.appendChild(wrap);
    container.appendChild(dEl);
  });
}
function deleteDay(date){ save(load().filter(e=>e.date!==date)); render(); }

/* Weekgrafiek + totaal */
let weekOffset = 0;
function drawWeek(){
  const bars=document.getElementById('bars'),
        labels=document.getElementById('xlabels'),
        yt=document.getElementById('yticks');
  bars.innerHTML=''; labels.innerHTML=''; yt.innerHTML='';

  const baseMon = mondayOfWeek( addDays(new Date(), weekOffset*7) );
  const endSun  = addDays(baseMon,6);
  const startISO = ymdLocal(baseMon), endISO = ymdLocal(endSun);
  document.getElementById('weekRange').textContent =
    `${toEU(startISO)} – ${toEU(endISO)}${weekOffset===0?' (deze week)':''}`;

  const days = Array.from({length:7},(_,i)=> addDays(baseMon,i));
  const dayTotals = days.map(d=> totalPerDate( ymdLocal(d) )/60); // uren

  // totaal week
  const weekMin = Math.round(dayTotals.reduce((s,h)=> s + h*60, 0));
  document.getElementById('weekTotal').textContent = 'Totaal week: ' + toHM(weekMin);

  // raster
  const maxH=Math.max(AVG_DAY_HOURS*1.6, ...dayTotals, 1);
  const steps=4;
  for(let i=0;i<=steps;i++){
    const line=document.createElement('div');
    line.className='tick'; line.style.top=`${100-(i/steps)*100}%`;
    yt.appendChild(line);
  }
  document.getElementById('targetLine').style.top = `${100 - (AVG_DAY_HOURS/maxH)*100}%`;

  const weekday=['Ma','Di','Wo','Do','Vr','Za','Zo'];
  dayTotals.forEach((h,i)=>{
    const b=document.createElement('div'); b.className='bar';
    b.style.height=`calc(${Math.max(0,Math.min(100,h/maxH*100))}% - 1px)`;
    const v=document.createElement('div'); v.className='val';
    v.textContent = h? h.toFixed(2).replace('.',',') : '';
    b.appendChild(v); bars.appendChild(b);
    const xl=document.createElement('div'); xl.textContent=weekday[i]; labels.appendChild(xl);
  });
}

/* --- Actions --- */
function computeTotalMin(start,end,pauses,pauseExtraMin=0){
  const gross = (start && end)? diffHM(start,end) : 0;
  const pmin = (sumPauses(pauses)||0) + (Number(pauseExtraMin)||0);
  return Math.max(0, gross - pmin);
}

function saveFromForm(){
  const date = document.getElementById('date').value || todayISO();
  const s = document.getElementById('start').value;
  const e = document.getElementById('end').value;
  const pauses = collectPauses('pauseList');
  const pauseMin = Number(document.getElementById('pauseExtra').value||0);
  let totalWorked = Number(document.getElementById('totalOverride').value||0);
  if(!totalWorked){ if(s && e){ totalWorked = computeTotalMin(s,e,pauses,pauseMin); } }
  if(!totalWorked){ alert('Vul start/einde (+ pauzes) in of een totaal gewerkt aantal minuten.'); return; }
  const note = document.getElementById('dayNote').value.trim();
  const entry = { id: crypto.randomUUID(), date, start:s||null, end:e||null, pauses, pauseMin: pauseMin||0, totalMin: totalWorked, note: note||undefined, source:'form' };
  upsert(entry);
  clearForm();
}

function clearForm(){
  ['start','end','pauseExtra','totalOverride','dayNote'].forEach(id=> document.getElementById(id).value='');
  document.getElementById('date').value = todayISO();
  document.getElementById('pauseList').innerHTML=''; makePauseRow('pauseList');
}
function setNow(id){ const now=new Date(); const t=pad(now.getHours())+":"+pad(now.getMinutes()); document.getElementById(id).value=t; }

/* Export/Import */
function entriesInRange(startDateISO, endDateISO){
  const map=entriesByDate(); const out=[];
  Object.keys(map).forEach(d=>{ if(d>=startDateISO && d<=endDateISO){ out.push(...map[d]); }});
  return out.sort((a,b)=> (a.date+(a.start||'')) < (b.date+(b.start||'')) ? -1:1);
}
function entryToCsvRow(e){
  const pauseTotal = totalPauseMinutes(e);
  const pauseNotes = (e.pauses||[]).map(p=>p.note).filter(Boolean).join('; ');
  const tePresteren = Math.round(AVG_DAY_HOURS*60);
  return [ e.date, e.start||'', e.end||'', e.totalMin, tePresteren, pauseTotal, `"${(pauseNotes||'').replaceAll('"','""')}"` ].join(',');
}
function exportWeekCsv(){
  const now=new Date(); const mon=mondayOfWeek(now);
  const startISO=ymdLocal(mon);
  const list=entriesInRange(startISO, ymdLocal(addDays(mon,6)));
  const header='datum,startuur,stopuur,totaal_gewerkt_min,totaal_te_presteren_min,totaal_min_pauze,notities_pauze\n';
  const csv = header + list.map(entryToCsvRow).join('\n');
  download(`prikklok-week-${startISO}.csv`, csv, 'text/csv');
}
function exportMonthCsv(){
  const now=new Date(); const {start,end}=monthSpan(now);
  const startISO=ymdLocal(start);
  const list=entriesInRange(startISO, ymdLocal(end));
  const header='datum,startuur,stopuur,totaal_gewerkt_min,totaal_te_presteren_min,totaal_min_pauze,notities_pauze\n';
  const csv = header + list.map(entryToCsvRow).join('\n');
  download(`prikklok-maand-${startISO.slice(0,7)}.csv`, csv, 'text/csv');
}
function exportJson(){ download('prikklok-export.json', JSON.stringify(load(),null,2), 'application/json'); }
function importJsonFile(file){
  const reader=new FileReader();
  reader.onload = () => { try{
      const incoming=JSON.parse(reader.result||'[]');
      if(!Array.isArray(incoming)) throw new Error('Geen lijst');
      save(incoming); render();
    }catch(e){ alert('Kon JSON niet importeren.'); }
  };
  reader.readAsText(file);
}

/* Wire up */
window.addEventListener('DOMContentLoaded',()=>{
  // Form
  document.getElementById('date').value = todayISO();
  document.getElementById('saveEntry').addEventListener('click', saveFromForm);
  document.getElementById('nowStart').addEventListener('click', ()=>setNow('start'));
  document.getElementById('nowEnd').addEventListener('click', ()=>setNow('end'));
  document.getElementById('clearForm').addEventListener('click', clearForm);
  document.getElementById('addPause').addEventListener('click', ()=>makePauseRow('pauseList'));
  makePauseRow('pauseList');

  // Export/import
  document.getElementById('exportWeekCsv').addEventListener('click', exportWeekCsv);
  document.getElementById('exportMonthCsv').addEventListener('click', exportMonthCsv);
  document.getElementById('exportJson').addEventListener('click', exportJson);
  document.getElementById('importJson').addEventListener('change', ev=>{ const f=ev.target.files?.[0]; if(f) importJsonFile(f); });

  // Gist creds
  document.getElementById('ghFile').value = localStorage.getItem(GIST_FILE_KEY) || DEFAULT_GIST_FILENAME;
  document.getElementById('ghGist').value = localStorage.getItem(GIST_ID_KEY) || '';
  document.getElementById('ghToken').value = localStorage.getItem(TOKEN_KEY) || '';
  document.getElementById('saveCreds').addEventListener('click', ()=>{
    const id=document.getElementById('ghGist').value.trim();
    const tk=document.getElementById('ghToken').value.trim();
    const fn=document.getElementById('ghFile').value.trim()||DEFAULT_GIST_FILENAME;
    if(id) localStorage.setItem(GIST_ID_KEY,id);
    if(tk) localStorage.setItem(TOKEN_KEY,tk);
    localStorage.setItem(GIST_FILE_KEY,fn);
    alert('Bewaar klaar. Herlaad de pagina om te synchroniseren.');
    location.reload();
  });

  // Auto sync
  syncPull();
  setInterval(syncPull, 5*60*1000);
  render();
  setInterval(render, 60*1000);

  // Week navigatie
  document.getElementById('prevWeek').addEventListener('click', ()=>{ weekOffset--; drawWeek(); });
  document.getElementById('nextWeek').addEventListener('click', ()=>{ weekOffset++; drawWeek(); });
  document.getElementById('thisWeek').addEventListener('click', ()=>{ weekOffset=0; drawWeek(); });

  // Swipe nav
  const wc = document.getElementById('weekChart'); let sx=null;
  wc.addEventListener('touchstart', e=>{ sx=e.changedTouches[0].clientX; }, {passive:true});
  wc.addEventListener('touchend', e=>{
    if(sx==null) return;
    const dx=e.changedTouches[0].clientX - sx;
    if(Math.abs(dx)>50){ weekOffset += dx<0 ? 1 : -1; drawWeek(); }
    sx=null;
  }, {passive:true});

  // Keyboard
  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft'){ weekOffset--; drawWeek(); }
    if(e.key==='ArrowRight'){ weekOffset++; drawWeek(); }
  });
});
</script>
</body>
</html>
